# Bell Inequality Violations in Agriculture Equity Networks

Analysis pipeline for detecting Bell inequality violations in agriculture-related equity returns and relating them to commodity volatility and network structure.

This repository is an updated and extended version of [56sarager/Final-Paper-Draft-](https://github.com/56sarager/Final-Paper-Draft-).

## Quick Start

```bash
# Install dependencies
pip install -r requirements.txt

# Run full pipeline (0 → 1 → 2 → 2Bootstrap → 2Fig2 → 2Fig3 → 3 → Granger → timing)
python run_all.py

# Verify computations
python verify_computations.py
```

Use `MPLBACKEND=Agg` if running headless (e.g., on a server) to avoid blocking on interactive plots.

## Pipeline Overview

| Step | Script | Input | Output |
|------|--------|-------|--------|
| 1 | `0.py` | `yfinance_tickers.csv` | `Results/s1_values.csv`, `Results/violation_pct.csv` |
| 2 | `1.py` | `Results/violation_pct.csv` | `Results/volatility_traces/*.csv`, `Fig01_volatility_and_violation.*` |
| 3 | `2.py` | `Results/s1_values.csv` | `Results/networks/*.csv`, `Figures/networks/*.html` |
| 4 | `scripts/compute_category_stats.py` | `Results/networks/`, `yfinance_tickers.csv` | `Results/category_stats.csv`, `Results/group_stats.csv` |
| 5 | `2Bootstrap.py` | `Results/volatility_traces/`, `Results/networks/` | `Results/event_tables/*.csv` |
| 6 | `2Fig2.py` | `Results/networks/` | `Fig02_network_metrics.*` |
| 7 | `2Fig3_networks.py` | `Results/s1_values.csv`, `Results/volatility_traces/`, `yfinance_tickers.csv` | `Fig03_networks.*` |
| 8 | `3.py` | `Results/volatility_traces/`, `Results/networks/` | `Results/event_tables/*.csv`, `Table01_main.*` |
| 9 | `Granger_causality.py` | `Results/violation_pct.csv`, `Results/volatility_traces/regime_vol.csv` | `Results/granger_results.csv`, `Table02_main.*`, `Fig05_granger_causality.*` |
| 10 | `timing_analysis.py` | `Results/violation_pct.csv`, `Results/volatility_traces/regime_vol.csv` | `Figures/Supplement/FigS1_*`, `Fig04_timing_lead_lag.*`, `Results/timing_lead_lag.*` |

## Data

- **Tickers**: `yfinance_tickers.csv` — agriculture-related Yahoo Finance tickers (generated by `python scripts/build_ticker_universe.py --scope global`)
- **S1 values**: Bell-CHSH correlator \(S_1 = E(a,b) + E(a,b') + E(a',b) - E(a',b')\)
- **Violation %**: Fraction of ticker pairs with \(|S_1| > 2\) per day
- **Volatility**: S&P GSCI (rolling, GARCH, regime-switching)

## Stock Selection Criteria

The equity universe is built from **VanEck Agribusiness ETF (MOO)** constituents, focusing on agriculture to complement Zarifian et al. (2025), who used the S&P 500.

| Criterion | Definition |
|-----------|------------|
| **Source** | MOO US constituents + ag-adjacent tickers (fertilizers, seeds, equipment, food processing, farmland REITs) |
| **Scope** | `moo` (~15 US only), `moo_plus` (~37), `global` (~43, adds international: Bayer, Yara, Mowi, Kubota, SalMar, K+S) |
| **Group** | GICS-based mapping via `config/industry_to_group.csv` (Fertilizers, Seeds & Crop Protection, Farm Machinery, Animal Health, etc.) |
| **Category** | **MNC** = non-US listing, market cap ≥ $50B, or override; **Pure Ag** = otherwise |
| **Filters** | Optional `--min-cap`; tickers with missing/delisted data dropped at download |

**Regenerate tickers:**
```bash
python scripts/build_ticker_universe.py --scope global
```

See [docs/STOCK_SELECTION.md](docs/STOCK_SELECTION.md) for full reference.

## Figures and Tables

### Figures

**Fig01. Volatility methods and S₁ violation percentage.** (A) Annualized volatility of the S&P GSCI: rolling realized (20-day), GARCH(1,1), and regime-switching. Dotted line indicates the 40% threshold used for extreme-period classification. (B) Daily fraction of ticker pairs with |S₁| > 2 (Bell inequality violations).

**Fig02. Network topology metrics as structural indicators of market fragility.** Panels show density, scale-free alpha, clustering coefficient, and community entropy over time, with vertical lines marking the 2008, COVID, and Ukraine crises.

**Fig03. Network structure during crisis periods.** Giant components of S₁-based correlation networks at peak volatility during the 2008, COVID-19, and Ukraine crises. Edges link stock pairs whose Bell-CHSH correlator |S₁| exceeds 2 (Bell inequality violation; correlations incompatible with classical hidden-variable models). Node size indicates degree (number of stocks with which each stock violates the Bell inequality); node color indicates sector group.

**Fig04. Lead–lag by crisis.** Bar chart of Δ (days) between S₁ violation and S&P GSCI volatility peaks for each crisis. Positive Δ = violation peaks after volatility; negative = volatility peaks first. Peak dates (agriculture universe): 2008 (violation 2009-03-31, volatility 2008-11-06, Δ = +145); COVID-19 (violation 2020-03-16, volatility 2020-04-03, Δ = −18); Ukraine (violation 2022-05-31, volatility 2022-03-28, Δ = +64). Timing patterns are sensitive to stock universe; the agriculture-focused set shows a later violation peak in 2008 than broader universes.

**Fig05. Granger causality by crisis.** S₁↔volatility tests at lags 1–10 for 2008, COVID-19, and Ukraine. Crisis-specific patterns differ: S₁ leads volatility only in 2008; volatility leads S₁ only in COVID-19; Ukraine shows no significant causality.

**FigS1 (Supplement). Timing cross-correlation.** Aggregate cross-correlation of violation % vs regime volatility at lags −30 to +30 days.

### Tables (main text)

**Table01. Network metrics between extreme and normal volatility periods.** Columns report means and percent change; p values are from permutation tests (100,000 permutations).

**Table02. Granger causality between S₁ violation and S&P GSCI volatility by crisis.** Entries show significant lags (p < 0.05) for each direction; em dash indicates no significant causality at any lag.

## Documentation

- [docs/ANALYSIS.md](docs/ANALYSIS.md) — Mathematical definitions and methodology
- [docs/STOCK_SELECTION.md](docs/STOCK_SELECTION.md) — Stock selection methodology and MOO reference

## Requirements

See `requirements.txt`. Key: numpy, pandas, yfinance, arch, statsmodels, networkx, plotly, matplotlib.
